name: ðŸš€ Production Deployment - ACR to Container Apps

on:
  push:
    branches: [ main ]
    paths:
      # Only trigger ACR build when application code changes
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'Dockerfile*'
      - '.github/workflows/production-deploy.yml'
      - 'azure/**'
      - 'scripts/build-*.sh'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'tests/**'
      - '.eslintrc*'
      - '.prettierrc*'
      - 'jest.config.js'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY_NAME: genztranslatoracrcentralus
  REGISTRY_LOGIN_SERVER: genztranslatoracrcentralus.azurecr.io
  IMAGE_NAME: hacksaws2x4
  CONTAINER_APP_NAME: hacksaws2x4
  RESOURCE_GROUP: dugganusa-RG
  NODE_VERSION: '20.x'

jobs:
  # Check if ACR build is needed based on changes
  check-changes:
    name: ðŸ” Check Build Requirements
    runs-on: ubuntu-latest
    outputs:
      needs-build: ${{ steps.changes.outputs.needs-build }}
      changed-files: ${{ steps.changes.outputs.changed-files }}
    steps:
      - name: ðŸ›Ž Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Analyze Changes
        id: changes
        run: |
          echo "Analyzing changes to determine if ACR build is needed..."

          # Get changed files in this push
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')
          echo "changed-files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

          # Check if any critical files changed that require rebuild
          NEEDS_BUILD=false

          # Check source code changes
          if git diff --name-only HEAD~1 HEAD | grep -E '^src/|^public/|package.*\.json|Dockerfile|scripts/build-' > /dev/null; then
            echo "âœ… Application code or build files changed - ACR build required"
            NEEDS_BUILD=true
          fi

          # Check Azure configuration changes
          if git diff --name-only HEAD~1 HEAD | grep -E '^azure/|\.github/workflows/production-deploy\.yml' > /dev/null; then
            echo "âœ… Deployment configuration changed - ACR build required"
            NEEDS_BUILD=true
          fi

          # Always build on manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "âœ… Manual trigger - ACR build required"
            NEEDS_BUILD=true
          fi

          echo "needs-build=$NEEDS_BUILD" >> $GITHUB_OUTPUT
          echo "Build needed: $NEEDS_BUILD"

  # Build optimized production image for AMD64 (conditional)
  build-and-push:
    name: ðŸ³ Build & Push to ACR
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.needs-build == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: ðŸ›Ž Checkout
        uses: actions/checkout@v4

      - name: ðŸ”‘ Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login to ACR
        run: az acr login --name ${{ env.REGISTRY_NAME }}

      - name: ðŸ“¦ Setup Docker Buildx (AMD64)
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: ðŸ·ï¸ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=production,enable={{is_default_branch}}

      - name: ðŸ”¨ Build and Push to ACR
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.optimized
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: ðŸ“Š Image Details
        run: |
          echo "## ðŸ³ Container Image Built" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ${{ env.REGISTRY_LOGIN_SERVER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY

  # Enhanced security validation (non-blocking)
  security-validation:
    name: ðŸ›¡ï¸ Security Validation
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: ðŸ›Ž Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install Dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ðŸ› ï¸ Setup Security Tools (Cached)
        uses: actions/cache@v4
        id: security-cache
        with:
          path: |
            ~/.local/bin
            ~/.cache/pip
          key: security-tools-${{ runner.os }}-v2
          restore-keys: |
            security-tools-${{ runner.os }}-

      - name: ðŸ”§ Install Security Tools
        if: steps.security-cache.outputs.cache-hit != 'true'
        run: |
          # Install TruffleHog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | \
            sh -s -- -b ~/.local/bin v3.90.8

          # Install Semgrep
          python3 -m pip install --user semgrep==1.137.0

          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ” Security Scanning (Non-blocking)
        continue-on-error: true
        run: |
          echo "## ðŸ›¡ï¸ Security Validation Results" >> $GITHUB_STEP_SUMMARY

          # NPM Audit
          echo "### ðŸ“Š NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          if npm audit --audit-level moderate; then
            echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Vulnerabilities detected (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          # TruffleHog
          echo "### ðŸ· Secret Detection" >> $GITHUB_STEP_SUMMARY
          if ~/.local/bin/trufflehog filesystem . --only-verified=false --quiet; then
            echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Potential secrets found (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          # Semgrep
          echo "### ðŸ” SAST Analysis" >> $GITHUB_STEP_SUMMARY
          if ~/.local/bin/semgrep --config=auto src/ --quiet --severity=WARNING; then
            echo "âœ… SAST analysis passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ SAST issues found (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

  # Deploy to Azure Container Apps (only if build succeeded or no build needed)
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [check-changes, build-and-push, security-validation]
    if: |
      always() && (
        (needs.check-changes.outputs.needs-build == 'true' && needs.build-and-push.result == 'success') ||
        (needs.check-changes.outputs.needs-build == 'false')
      )
    environment: production
    steps:
      - name: ðŸ”‘ Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Container Apps
        id: deploy
        run: |
          if [ "${{ needs.check-changes.outputs.needs-build }}" = "true" ]; then
            echo "Deploying new ACR image to Azure Container Apps..."

            # Get the latest production image
            IMAGE_TAG="${{ env.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:production"

            # Update Container App with new image
            az containerapp update \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image $IMAGE_TAG \
              --output table

            echo "deployment-type=new-image" >> $GITHUB_OUTPUT
          else
            echo "No ACR build required - skipping image deployment"
            echo "Checking current Container App status..."

            # Just verify current deployment status
            az containerapp show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query "{name: name, status: properties.runningStatus, image: properties.template.containers[0].image}" \
              --output table

            echo "deployment-type=status-check" >> $GITHUB_OUTPUT
          fi

          # Wait for deployment to complete
          echo "Waiting for deployment to stabilize..."
          sleep 30

          # Get the app URL
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)

          echo "app-url=https://$APP_URL" >> $GITHUB_OUTPUT

      - name: ðŸ§ª Health Check
        id: health-check
        run: |
          APP_URL="${{ steps.deploy.outputs.app-url }}"

          echo "Testing health endpoint: $APP_URL/health"

          # Test health endpoint
          if curl -f -s "$APP_URL/health" > /dev/null; then
            echo "âœ… Health check passed" >> $GITHUB_STEP_SUMMARY
            echo "health-status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Health check failed" >> $GITHUB_STEP_SUMMARY
            echo "health-status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŽ¯ Test API Functionality
        continue-on-error: true
        run: |
          APP_URL="${{ steps.deploy.outputs.app-url }}"

          echo "## ðŸ§ª API Functionality Tests" >> $GITHUB_STEP_SUMMARY

          # Test content extraction
          echo "### ðŸ“Š Content Extraction Test" >> $GITHUB_STEP_SUMMARY
          if curl -s -X POST "$APP_URL/extract" \
               -H "Content-Type: application/json" \
               -d '{"url": "https://nypost.com"}' | grep -q "success"; then
            echo "âœ… Content extraction working" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Content extraction issue (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL**: ${{ steps.deploy.outputs.app-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Status**: ${{ steps.health-check.outputs.health-status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Type**: ${{ steps.deploy.outputs.deployment-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Required**: ${{ needs.check-changes.outputs.needs-build }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Files**: ${{ needs.check-changes.outputs.changed-files }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-changes.outputs.needs-build }}" = "true" ]; then
            echo "- **Image**: ${{ env.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:production" >> $GITHUB_STEP_SUMMARY
            echo "- **Platform**: linux/amd64 (Azure optimized)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **hacksaws2x4 v3.0.0 deployed with new ACR image!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **No deployment needed - application code unchanged**" >> $GITHUB_STEP_SUMMARY
          fi

  # Post-deployment monitoring
  post-deploy:
    name: ðŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && (needs.deploy.result == 'success')
    steps:
      - name: ðŸ”‘ Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“ˆ Container App Status
        run: |
          echo "## ðŸ“Š Container App Status" >> $GITHUB_STEP_SUMMARY

          # Get detailed status
          az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "{
              name: name,
              status: properties.runningStatus,
              replicas: properties.template.scale,
              image: properties.template.containers[0].image,
              cpu: properties.template.containers[0].resources.cpu,
              memory: properties.template.containers[0].resources.memory
            }" \
            --output table >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Recent Logs Sample
        continue-on-error: true
        run: |
          echo "## ðŸ“ Recent Application Logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          az containerapp logs show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --tail 10 \
            --follow false >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Logs not available yet"

          echo '```' >> $GITHUB_STEP_SUMMARY